<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Family Tree Viewer</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" />
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      #network { width: 100%; height: 600px; border: 1px solid #ddd; }
      .controls { margin-bottom: 8px; }
    </style>
  </head>
  <body>
    <h3>Family Tree Viewer</h3>
    <div class="controls">
      <input id="personId" placeholder="Person ID" />
      <select id="relation">
        <option value="graph">Graph (depth)</option>
        <option value="parents">Parents</option>
        <option value="grandparents">Grandparents</option>
        <option value="siblings">Siblings</option>
        <option value="parents-siblings">Parents' Siblings</option>
        <option value="cousins">Cousins</option>
        <option value="children">Children</option>
        <option value="grandchildren">Grandchildren</option>
      </select>
      <input id="depth" type="number" value="2" style="width:64px" />
      <button id="showBtn">Show</button>
    </div>
    <div id="network"></div>

    <script>
      const networkContainer = document.getElementById('network');
      let network;

      function renderGraph(nodes, edges, highlightIds) {
        const visNodes = nodes.map(n => ({ id: n.id, label: n.name, title: n.name, color: highlightIds && highlightIds.includes(n.id) ? '#ffcc00' : undefined }));
        const visEdges = edges.map(e => ({ from: e.sourceId || e.source || e.sourceId, to: e.targetId || e.target || e.targetId, label: e.type || '' }));
        const data = { nodes: new vis.DataSet(visNodes), edges: new vis.DataSet(visEdges) };
        const options = { layout: { hierarchical: { enabled: true, sortMethod: 'directed' } }, edges: { arrows: { to: { enabled: true } } } };
        if (network) network.destroy();
        network = new vis.Network(networkContainer, data, options);
      }

      async function fetchGraph(personId, depth) {
        const res = await fetch(`/api/people/${personId}/graph?depth=${depth}`);
        if (!res.ok) throw new Error('graph request failed');
        return res.json();
      }

      async function fetchRelation(personId, rel) {
        const res = await fetch(`/api/people/${personId}/relations/${rel}`);
        if (!res.ok) throw new Error('relation request failed');
        return res.json();
      }

      document.getElementById('showBtn').addEventListener('click', async () => {
        const id = document.getElementById('personId').value.trim();
        if (!id) return alert('Enter person id');
        const rel = document.getElementById('relation').value;
        const depth = parseInt(document.getElementById('depth').value || '2', 10);
        try {
          const graph = await fetchGraph(id, depth);
          let highlight = [];
          if (rel !== 'graph') {
            const relList = await fetchRelation(id, rel);
            highlight = relList.map(p => p.id);
          }
          const nodes = Array.from(graph.nodes || []).map(n => ({ id: n.id || n["id"], name: n.name || n["name"] }));
          const edges = Array.from(graph.edges || []).map(e => ({ sourceId: e.sourceId || e.source || e.from, targetId: e.targetId || e.target || e.to, type: e.type || '' }));
          renderGraph(nodes, edges, highlight);
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
    </script>
  </body>
</html>
